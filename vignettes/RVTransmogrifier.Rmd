---
title: "RVTransmogrifier"
subtitle: "A package for reformatting and working with the DFO Maritimes Groundfish Survey Data."
date: "`r format(Sys.time(), '%B %d, %Y')`"
author: "Mike McMahon"
email: "Mike.McMahon@dfo-mpo.gc.ca"
affiliation: "Population Ecology Division - Fisheries and Oceans Canada"
output: 
    rmarkdown::pdf_document: default
    engine: pdfLaTeX
  
vignette: >
  %\VignetteIndexEntry{RVTransmogrifier}
  %\VignetteEngine{knitr::rmarkdown}
  % \VignetteDepends{dplyr} 
  % \VignetteDepends{ggplot2} 
  % \VignetteDepends{mapdata} 
  % \VignetteDepends{sf} 
  \usepackage[utf8]{inputenc}
---
```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r, dependencies, include=FALSE}
library(RVSurveyData)
library(Mar.utils)

library(dplyr)
library(ggplot2)
library(lubridate)
library(mapdata)
library(maps)
library(tidyr)
library(reshape2)
library(stats)
library(sf)

sourcery(Rdir = "C:/git/PopulationEcologyDivision/RVTransmogrifier/R/")
```

[![an actual transmogrifier](transmogrifier_400x400.jpg){width="200" height="200"}](https://calvinandhobbes.fandom.com/wiki/Transmogrifier "an actual transmogrifier")

[**trans·mog·ri·fy**](https://www.merriam-webster.com/dictionary/transmogrify)
*verb* <font style="font-size:9pt; font-style:bold">HUMOROUS</font>

> transform in a surprising or magical manner.
>*"the cucumbers that were ultimately transmogrified into pickles"*

The [RVSurveyData])(https://github.com/PopulationEcologyDivision/RVSurveyData) package is a data-only package, and does not contain any tools for making sense of its' data. This package  [(RVTransmogrifier)](https://github.com/PopulationEcologyDivision/RVTransmogrifier) is not strictly necessary, but it endeavours to make working with the RV data a bit easier.  It includes tools for loading, filtering and plotting the data, as well as reformatting it for contribution to different systems.

## Installation
```{r install-RVTransmogrifier, eval=FALSE}
devtools::install_github("PopulationEcologyDivision/RVTransmogrifier")
```

## Querying data
### Introduction
This package pulls data from the [RVSurveyData package](https://github.com/PopulationEcologyDivision/RVSurveyData) into a list, and can cascade user-imposed filters performed on a single data object to all of the other related data objects.  Anyone having used the [Mar.datawrangling package](https://github.com/Maritimes/Mar.datawrangling) will find this process familiar.  

For example, if we wanted to limit the entire RV Survey data to only data associated with:

* species = cod (i.e Gadus morhua (code=10))
* years 2014 and 2015
* summer

We could do so via the following:
```{r eval=FALSE}
#load the package
library(RVTransmogrifier)

#load the data into an object
data <- loadRVData()

# check how many Catch records exist initially
nrow(data$GSCAT)
[1] 259818

#apply the filters above (any table can have filters applied)
data$GSMISSIONS <- data$GSMISSIONS[data$GSMISSIONS$SEASON=="SUMMER",]
data$GSMISSIONS <- data$GSMISSIONS[data$GSMISSIONS$YEAR %in% c(2014,2015),]
data$GSSPECIES_20220624  <- data$GSSPECIES_20220624[data$GSSPECIES_20220624$CODE == 10,]

#cascade the filters above to all of the data
data <- propagateChanges(data, keep_nullsets = F)

# check that filter worked
nrow(data$GSCAT)
[1] 197

```
At this point, every table within the `data` object will only hold information directly relevant to the filters we applied.  The various tables will only hold records that can be directly linked to cod caught in the summers of 2014 and 2015.  Tables that exist but were not explicitly filtered have also be filtered.  For example, even the table that holds length, weight and age information for specific fish (i.e. `GSDET`) can now be plotted, and we can be confident it will only contain cod data:

```{r eval=FALSE}
plot(data$dataLF$FLEN, data$dataLF$FWT, pch = 19, col=factor(data$dataLF$MISSION))
legend("topleft", pch = 19, legend = unique(factor(data$dataLF$MISSION)), col = unique(factor(data$GSDET$MISSION)))
```

To "reset" the data (and remove any filtering), one would just re-run `loadRVData()` and overwrite the filtered dataset.

### TAXA level extractions
With the addition of [WoRMS aphiaids](https://www.marinespecies.org/about.php) to the species table (i.e. GSSPECIES, it is now possible to filter data at any taxonomic level rather than just discrete species.  

For example, to generate a dataset of only data for polychaetes, one could do the following
```{r eval=FALSE}
data<-loadRVData()
data$GSSPECIES<- data$GSSPECIES[which(data$GSSPECIES$CLASS == "POLYCHAETA"),]
data <- propagateChanges(data, keep_nullsets = F)
#Review contents of data$GSSPECIES element following filtering
> unique(data$GSSPECIES$SPEC)
 [1] "EUNICIDAE F."                  "POLYCHAETA C."                 "NEPHTYS SP."                  
 [4] "NEPHTYIDAE F."                 "NEREIS SP."                    "SABELLIDAE F."                
 [7] "MALDANIDAE F."                 "PECTINARIA SP."                "POTAMILLA NEGLECTA"           
[10] "NEREIDAE F."                   "OPHELIA SP."                   "TEREBELLIDAE F."              
[13] "ARENICOLA MARINA"              "SPIONIDA F."                   "TEREBELLIDA"                  
[16] "OWENIIDAE F."                  "APHRODITA HASTATA"             "APHRODITIDAE F."              
[19] "APHRODITA ACULEATA (OBSOLETE)" "APHRODITA SP."                 "CHONE SP."                    
[22] "POLYNOIDAE F."                 "LEPIDONOTUS SQUAMATUS"         "HARMOTHOE SP."                
[25] "HARMOTHOE EXTENUATA"           "GLYCERA SP."                   "GLYCERA CAPITATA"             
[28] "HYALINOECIA CF TUBICOLA"       "LAETMONICE FILICORNIS" 

```

### Extracting Survey Data via RVTransmogrify
Generally, when working with the RV Survey data, only a subset of the 50 years of data is desired for any given analysis.  Whether the interest is a particular survey, a particular species, or a particular area, a number of filtering steps will are generally required.  RVTransmogrifier attempts to make the process a bit easier.  A particular survey is defined by a combination of parameters, including:
  1. a range of months;
  2. a particular set of strata; and
  3. a particular tow 'type' (i.e. a "Stratified random survey set")
Because getting all of these things correct can be a little difficult, [getSurvey()](https://github.com/PopulationEcologyDivision/RVTransmogrifier/blob/main/R/getSurvey.R) is included to ensure they are applied correctly.  

Some common parameters that can be sent to `getSurvey()` include :

* "survey" (see table below for how this impacts selection via strata and the time of year of the survey was performed)
* "years" (1970-present, but some surveys are only available for a subset of this time)
* "code"/"aphiaid"/"taxa"
    * "code" - this is the species code found in GSSPECIES (e.g. cod = 10)
    * "aphiaid" - this is the aphiaid found in GSSPECIES  (e.g. cod = 126436)
    * "taxa" - any taxonomic identifier found in GSSPECIES (e.g. "TELEOSTEI", "GADIDAE", "GADIFORMES" and "GADUS" would all include cod)

| PARAMETER        | Months           | Strata  |
|----------|:-------------:|:-------------------------------:|
| SUMMER          | months 5:8      | "440", "441", "442", "443", "444", "445", "446", "447", "448", "449", "450", "451", "452", "453", "454", "455", "456", "457", "458", "459", "460", "461", "462", "463", "464", "465", "466", "470", "471", "472", "473", "474", "475", "476", "477", "478", "480", "481", "482", "483", "484", "485", "490", "491", "492", "493", "494", "495" |
| SUMMER_ALL      | months 5:8      | "434", "436", "437", "438", "439", "440", "441", "442", "443", "444", "445", "446", "447", "448", "449", "450", "451", "452", "453", "454", "455", "456", "457", "458", "459", "460", "461",  "462", "463", "464", "465", "466", "470", "471", "472", "473", "474", "475", "476", "477", "478", "480", "481", "482", "483", "484", "485", "490", "491", "492", "493", "494", "495", "496", "497", "498", "501", "502", "503", "504",  "505", "557", "558", "559", "5Z1", "5Z2", "5Z3", "5Z4", "5Z5", "5Z6", "5Z7","5Z8", "5Z9" |
| GEORGES         | months 1:4      | "5Z1", "5Z2", "5Z3", "5Z4", "5Z5", "5Z6", "5Z7", "5Z8", "5Z9" |
| SPRING          | months 1:4      | "396","397", "398", "399", "400", "401", "402", "403", "404", "405", "406", "407", "408", "409", "410", "411", "551", "552", "553", "554", "555", "556", "557", "558", "559" |
| FALL            | months 9:12     |   <any> |
| 4VSW            | months 1:4      |  "396","397", "398", "399", "400", "401", "402", "403", "404", "405", "406", "407", "408", "409", "410", "411" |

Below is an example of using RVTransmogrify to extract the same Summer 2016 survey data.  `getSurvey()` results in a single list object that contains all of the individual data objects the survey.

```{r extract-2016-transmogrified}
cod_2016_transmogrified <- getSurvey("SUMMER_ALL", years = 2016, code=10)
#nrow(cod_2016_transmogrified$GSINF)
nrow(cod_2016_transmogrified$dataDETS)
```

If we look at the number of rows remaining from each filtering method, we can see they're the same:
```{r manual-filtering, echo=FALSE, collapse=TRUE}
message("manual filtering")
print(paste0("GSMISSIONS:", nrow(GSMISSIONS)))
print(paste0("GSINF:", nrow(GSINF)))
print(paste0("GSCAT:", nrow(GSCAT)))
print(paste0("dataDETS:", nrow(dataDETS)))

message("RVTransmogrifier filtering")
paste(paste0("cod_2016_transmogrified$GSMISSIONS:",nrow(cod_2016_transmogrified$GSMISSIONS)))
paste(paste0("cod_2016_transmogrified$GSINF:",nrow(cod_2016_transmogrified$GSINF)))
paste(paste0("cod_2016_transmogrified$GSCAT:",nrow(cod_2016_transmogrified$GSCAT)))
paste(paste0("cod_2016_transmogrified$dataDETS:",nrow(cod_2016_transmogrified$dataDETS)))
```

## Plotting Survey Data
### Plotting Manually
In order to plot the manually extracted data, we must associate the Catch data (i.e. GSCAT) with the set location data (i.e. GSINF)
```{r manual-figures, fig.width = 10}
cod_2016_wrangled <- merge(GSCAT, GSINF, all.y=T, by=c("MISSION", "SETNO"))
codPlot <-  ggplot2::ggplot()
# add cod data
codPlot <- codPlot + ggplot2::geom_point(data=cod_2016_wrangled[!is.na(cod_2016_wrangled$TOTWGT),], aes(x = SLONG_DD, y=SLAT_DD, size=TOTWGT), colour="blue")
#add nullsets
codPlot <- codPlot + ggplot2::geom_point(data=cod_2016_wrangled[is.na(cod_2016_wrangled$TOTWGT),], aes(x = SLONG_DD, y=SLAT_DD), shape = 3, colour="black", size = 2)
# add some land
codPlot <- codPlot + ggplot2::geom_polygon(data = RVSurveyData::maritimesLand, ggplot2::aes(x = long, y = lat, group = group), fill = "darkgrey", color = NA) 
# set the extent of the plot using the data
limits<- c(range(cod_2016_wrangled[!is.na(cod_2016_wrangled$TOTWGT),"SLONG_DD"]),range(cod_2016_wrangled[!is.na(cod_2016_wrangled$TOTWGT),"SLAT_DD"]))
codPlot <- codPlot + ggplot2::coord_sf(xlim = c(limits[1],limits[2]), ylim = c(limits[3], limits[4]))
# pretty up the labels a bit
codPlot <- codPlot + ggplot2::labs(x="Longitude", y="Latitude", size = "Total Weight (kgs)")
#show it
codPlot
```
The results above do make a reasonable plot, but they took quite a few steps.  Further, the plotted data included a number of points which shouldn't be used for assessing fish stocks (shown in red, below).
```{r manual-plots-badpoints, fig.width = 10}
codPlot <- codPlot + ggplot2::geom_point(data=cod_2016_wrangled[cod_2016_wrangled$TYPE!=1,], aes(x = SLONG_DD, y=SLAT_DD), shape = 4, colour="red", size = 4)
codPlot
```

### Plotting via RVTransmogrifier
RVTransmogrifier reduces the steps above significantly. Generating a plot of the same cod data is made easier through the `plotRV()` function.  Additionally, the plot is a bit more polished and can include bathymetry:
```{r transmogrified-cod, collapse = TRUE, fig.width = 10,  warning=FALSE}
cod_2016_transmogrified <- getSurvey("SUMMER", years = 2016, code=10) 
codPlot_transmogrified <- plotRV(cod_2016_transmogrified, plotSets = "TOTWGT", plotBathy = "FILL")  
codPlot_transmogrified
```

In the example above, we specified that we were only interested in cod (10).  Alternatively, we can extract the data for all species, and leave the species filtering to `plotRV()`.  Doing so makes generating plots for a number of species at once straightforward:
```{r, fig.width = 10,  warning=FALSE}
transmogrified_2016 <- getSurvey("SUMMER", years = 2016)  #removed "code=10"
species <- c(14,42,2550) #, Silver hake/yellowtail flounder/lobster -->
for (s in species){
  spPlot <- plotRV(transmogrified_2016, code=s, plotSets = "TOTWGT", plotBathy = "FILL")
  spPlot
}
```

One of the features of RVTransmogrifier is th use of a biological taxa as a mean of data selection.  Below are examples of plotting MALACOSTRACA and MYCTOPHIFORMES, which is an otherwise difficult thing to produce:
```{r transmogrified-taxa, collapse = TRUE, fig.width = 10,  warning=FALSE}
taxa_2019_2020_transmogrified <- getSurvey("SUMMER", years = c(2019,2020), taxa=c("MALACOSTRACA", "MYCTOPHIFORMES")) 
MALACOSTRACA_2019_2020_transmogrified <- plotRV(taxa_2019_2020_transmogrified, taxa = "MALACOSTRACA", plotSets = "TOTNO", plotBathy = "FILL") 
MYCTOPHIFORMES_2019_2020_transmogrified <- plotRV(taxa_2019_2020_transmogrified, taxa = "MYCTOPHIFORMES", plotSets = "TOTNO", plotBathy = "FILL")  

MALACOSTRACA_2019_2020_transmogrified
MYCTOPHIFORMES_2019_2020_transmogrified

```

## Generating Data Products
The primary impetus of this package was to address the need to provide versions of this data to multiple parties. 

### extractFGP - Generating Data for Open Data Canada
Data from the RV Survey Data dataset exists on [Open Data Canada](https://open.canada.ca/data/en/dataset/8ddcaeea-b806-4958-a79f-ba9ab645f53b):

* [Summer](https://open.canada.ca/data/en/dataset/8ddcaeea-b806-4958-a79f-ba9ab645f53b/resource/dd481775-53e2-485f-ba3c-f5395d07a4a5)
* [Spring](https://open.canada.ca/data/en/dataset/8ddcaeea-b806-4958-a79f-ba9ab645f53b/resource/dd481775-53e2-485f-ba3c-f5395d07a4a5)
* [Fall](https://open.canada.ca/data/en/dataset/8ddcaeea-b806-4958-a79f-ba9ab645f53b/resource/73154215-9d65-48ba-9cc3-cdce97b81489)
* [4VSW](https://open.canada.ca/data/en/dataset/8ddcaeea-b806-4958-a79f-ba9ab645f53b/resource/2613c2f6-412e-48ce-85ae-be5bbd25d0cc)

With RVTransmogrifier, as new data becomes available, the data products provided to Open Data can now be generated virtually instantly.  The following command will build the shapefiles and csv files for the SUMMER, SPRING, FALL and 4VSW surveys for all years for which data is available for each survey (i.e. varies, but 1970+). 

```{r eval=FALSE}
extractFGP()
```
Additionally, if there is a need to generate Open Data Canada - style datasets for only a subset of year(s) and/or survey(s), it can be accomplished by providing a couple parameters:
```{r eval=FALSE}
extractFGP(years = 2021, survey=c("SPRING", "SUMMER"))
```

### extractOBIS - Generating Data for OBIS Canada (in progress)
Data from the RV Survey Data dataset also exists on [OBIS](https://obis.org/):

* [Summer](http://ipt.iobis.org/obiscanada/resource?r=maritimes_summer_rv_surveys)
* [Spring](http://ipt.iobis.org/obiscanada/resource?r=maritimes_spring_rv_surveys)
* [Fall](http://ipt.iobis.org/obiscanada/resource?r=maritimes_fall_rv_surveys)
* [4VSW](http://ipt.iobis.org/obiscanada/resource?r=maritimes_4vsw_rv_surveys)

`extractOBIS()` will function virtually identically to `extractFGP()` - facilitating the creation of OBIS-compliant datasets immediately after new survey data has been QC'd.

### Upcoming - DATRAS
* Hopefully we can migrate the code from [here](https://github.com/Maritimes/CanaDatras), to build `extractDATRAS()`, but that effort has not yet begun.
