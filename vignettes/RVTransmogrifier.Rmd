---
title: "RVTransmogrifier"
subtitle: "A package for reformatting and working with the DFO Maritimes Groundfish Survey Data."
date: "`r format(Sys.time(), '%B %d, %Y')`"
author: "Mike McMahon"
email: "Mike.McMahon@dfo-mpo.gc.ca"
affiliation: "Population Ecology Division - Fisheries and Oceans Canada"
output: 
    rmarkdown::html_vignette: default
    rmarkdown::pdf_document: 
    engine: pdfLaTeX
  
vignette: >
  %\VignetteIndexEntry{RVTransmogrifier}
  %\VignetteEngine{knitr::rmarkdown}
  % \VignetteDepends{dplyr} 
  % \VignetteDepends{ggplot2} 
  % \VignetteDepends{mapdata} 
  % \VignetteDepends{sf} 
  \usepackage[utf8]{inputenc}
---
```{r, include=FALSE}
library(RVSurveyData)
library(Mar.utils)

library(dplyr)
library(ggplot2)
library(lubridate)
library(mapdata)
library(maps)
library(tidyr)
library(reshape2)
library(stats)
library(sf)

sourcery(Rdir = "C:/git/PopulationEcologyDivision/RVTransmogrifier/R/")
```
(<img src="transmogrifier_400x400.jpg" width="200" height="200" />)[https://calvinandhobbes.fandom.com/wiki/Transmogrifier "an actual transmogrifier"]

[**trans·mog·ri·fy**](https://www.merriam-webster.com/dictionary/transmogrify)
*verb* <font style="font-size:9pt; font-style:bold">HUMOROUS</font>

> transform in a surprising or magical manner.
>*"the cucumbers that were ultimately transmogrified into pickles"*

The [RVSurveyData])(https://github.com/PopulationEcologyDivision/RVSurveyData) package is a data-only package, and does not contain any tools for making sense of its' data. This package  [(RVTransmogrifier)](https://github.com/PopulationEcologyDivision/RVTransmogrifier) is not strictly necessary, but it endeavours to make working with the RV data a bit easier.  It includes tools for loading, filtering and plotting the data, as well as reformatting it for contribution to different systems.

## Installation
```{r eval=FALSE}
devtools::install_github("PopulationEcologyDivision/RVTransmogrifier")
```

## Accessing Survey Data
Generally, when working with the RV Survey data, only a subset of the 50 years of data is desired for any given analysis.  Whether the interest is a particular survey, a particular species, or a particular area, a number of filtering steps will required, and the filtering requires a bit of specialized knowledge.    

For example, if we are interested in the cod caught during the 2016 summer survey, we might do the following:
```{r}
library(RVSurveyData)
# limit missions to desired year and season
GSMISSIONS <- GSMISSIONS[GSMISSIONS$YEAR == 2016 & GSMISSIONS$SEASON == "SUMMER",]
# limit sets to valid stratified random sets only
GSINF      <- GSINF[GSINF$MISSION %in% GSMISSIONS$MISSION & GSINF$TYPE==1,]
# limit to cod
GSCAT      <- merge(GSCAT[GSCAT$SPEC == 10,], GSINF[,c("MISSION","SETNO")])
# retain only detailed records for matching records
dataDETS   <- merge(dataDETS, GSCAT[,c("MISSION","SETNO","SPEC")])

rm(list=c("GSMISSIONS", "GSINF", "GSCAT", "dataDETS"))

# nrow(dataDETS) 946
#... the amount of filtering would depend on what filters you required
```
While the steps above were not particularly onerous, they required a degree of familiarity with the data that most people don't have (i.e. which fields to filter on, which set types to include, and which fields are needed to join the various tables together, etc).

Below is an example of using RVTransmogrify to extract the same Summer 2016 survey data.  `getSurvey()` results in a single list object that contains all of the individual data objects the survey.

```{r}
cod_2016_transmogrified <- getSurvey("SUMMER", years = 2016, code=10)
nrow(cod_2016_transmogrified$GSINF)
```
If we look at the number of rows remaining from each filtering method, we can see they're the same:
```{r}
message("manual filtering")
paste("GSMISSIONS:", nrow(GSMISSIONS))
paste("GSINF:", nrow(GSINF))
paste("GSCAT:", nrow(GSCAT))
paste("dataDETS:", nrow(dataDETS))

message("RVTransmogrifier filtering")
paste("cod_2016_transmogrified$GSMISSIONS:",nrow(cod_2016_transmogrified$GSMISSIONS))
paste("cod_2016_transmogrified$GSINF:",nrow(cod_2016_transmogrified$GSINF))
paste("cod_2016_transmogrified$GSCAT:",nrow(cod_2016_transmogrified$GSCAT))
paste("cod_2016_transmogrified$dataDETS:",nrow(cod_2016_transmogrified$dataDETS))
```


3. Merge together appropriate objects...
```{r}
cod_2016_wrangled <- merge(GSCAT, GSINF, all.y=T, by=c("MISSION", "SETNO"))
```



4. Generate a plot...
```{r, fig.width = 10}
codPlot <-  ggplot2::ggplot()
# add cod data
codPlot <- codPlot + ggplot2::geom_point(data=cod_2016_wrangled[!is.na(cod_2016_wrangled$TOTWGT),], aes(x = SLONG_DD, y=SLAT_DD, size=TOTWGT), colour="blue")
#add nullsets
codPlot <- codPlot + ggplot2::geom_point(data=cod_2016_wrangled[is.na(cod_2016_wrangled$TOTWGT),], aes(x = SLONG_DD, y=SLAT_DD), shape = 3, colour="black", size = 2)
# add some land
codPlot <- codPlot + ggplot2::geom_polygon(data = RVSurveyData::maritimesLand, ggplot2::aes(x = long, y = lat, group = group), fill = "darkgrey", color = NA) 
# set the extent of the plot using the data
limits<- c(range(cod_2016_wrangled[!is.na(cod_2016_wrangled$TOTWGT),"SLONG_DD"]),range(cod_2016_wrangled[!is.na(cod_2016_wrangled$TOTWGT),"SLAT_DD"]))
codPlot <- codPlot + ggplot2::coord_sf(xlim = c(limits[1],limits[2]), ylim = c(limits[3], limits[4]))
# pretty up the labels a bit
codPlot <- codPlot + ggplot2::labs(x="Longitude", y="Latitude", size = "Total Weight (kgs)")
#show it
codPlot
```
The results above do make a reasonable plot, but they took quite a few steps.  Further, the plotted data includes a number of points which shouldn't be used for assessing fish stocks (shown in red, below).
```{r, fig.width = 10}
codPlot <- codPlot + ggplot2::geom_point(data=cod_2016_wrangled[cod_2016_wrangled$TYPE!=1,], aes(x = SLONG_DD, y=SLAT_DD), shape = 4, colour="red", size = 4)
codPlot
```


RVTransmogrifier reduces all of the steps above into 

### The Easy Way

The data can be viewed relatively easily.  Below, we list the names of all of the objects, and get 
the first few records of some of them.
```{r}
names(cod_2016_transmogrified)

head(cod_2016_transmogrified$GSCAT)
head(cod_2016_transmogrified$GSINF)
head(cod_2016_transmogrified$GSSPECIES)
```

Generating a plot of the same cod data is made easier through the `plotRV()` function.  Additionally, the plot is a bit more polished and can include bathymetry:

```{r, fig.width = 10,  warning=FALSE}
plotRV(cod_2016_transmogrified, plotSets = "TOTWGT", plotBathy = "FILL")  
```
<!-- Because all of the data is held in the same object, generating plots for a number of species at once becomes straightforward: -->
<!-- ```{r, fig.width = 15,  warning=FALSE} -->
<!-- species <- c(14,42,2550) #, Silver hake/yellowtail flounder/lobster -->
<!-- for (s in species){ -->
<!--   spPlot <- plotRV(cod_2016_transmogrified, code=s, plotSets = "TOTWGT", plotBathy = "FILL") -->
<!--   print(spPlot) -->
<!-- } -->
<!-- ``` -->


## extractFGP - Generating Data for Open Data Canada
Data from the RV Survey Data dataset exists on [Open Data Canada](https://open.canada.ca/data/en/dataset/8ddcaeea-b806-4958-a79f-ba9ab645f53b):

* [Summer](https://open.canada.ca/data/en/dataset/8ddcaeea-b806-4958-a79f-ba9ab645f53b/resource/dd481775-53e2-485f-ba3c-f5395d07a4a5)
* [Spring](https://open.canada.ca/data/en/dataset/8ddcaeea-b806-4958-a79f-ba9ab645f53b/resource/dd481775-53e2-485f-ba3c-f5395d07a4a5)
* [Fall](https://open.canada.ca/data/en/dataset/8ddcaeea-b806-4958-a79f-ba9ab645f53b/resource/73154215-9d65-48ba-9cc3-cdce97b81489)
* [4VSW](https://open.canada.ca/data/en/dataset/8ddcaeea-b806-4958-a79f-ba9ab645f53b/resource/2613c2f6-412e-48ce-85ae-be5bbd25d0cc)

With RVTransmogrifier, as new data becomes available, the data products provided to Open Data can now be generated virtually instantly.  The following command will build the shapefiles and csv files for the SUMMER, SPRING, FALL and 4VSW surveys for all years for which data is available for each survey (i.e. varies, but 1970+). 

```{r eval=FALSE}
extractFGP()
```
Additionally, if there is a need to generate Open Data Canada - style datasets for only a subset of year(s) and/or survey(s), it can be accomplished by providing a couple parameters:
```{r eval=FALSE}
extractFGP(years = 2021, survey=c("SPRING", "SUMMER"))
```

## extractOBIS - Generating Data for OBIS Canada (in progress)
Data from the RV Survey Data dataset also exists on [OBIS](https://obis.org/):

* [Summer](http://ipt.iobis.org/obiscanada/resource?r=maritimes_summer_rv_surveys)
* [Spring](http://ipt.iobis.org/obiscanada/resource?r=maritimes_spring_rv_surveys)
* [Fall](http://ipt.iobis.org/obiscanada/resource?r=maritimes_fall_rv_surveys)
* [4VSW](http://ipt.iobis.org/obiscanada/resource?r=maritimes_4vsw_rv_surveys)

`extractOBIS()` will function virtually identically to `extractFGP()` - facilitating the creation of OBIS-compliant datasets immediately after new survey data has been QC'd.

## Querying data - propagateChanges()
This package pulls data from the [RVSurveyData package](https://github.com/PopulationEcologyDivision/RVSurveyData) into a list, and can cascade user-imposed filters performed on a single data object to all of the other related data objects.  Anyone having used the [Mar.datawrangling package](https://github.com/Maritimes/Mar.datawrangling) will find this process familiar.  

For example, if we wanted to limit the entire RV Survey data to only data associated with:
* species = cod (i.e Gadus morhua (code=10))
* years 2014 and 2015
* summer

We could do so via the following:
```{r eval=FALSE}
#load the package
library(RVTransmogrifier)

#load the data into an object
data <- loadRVData()

# check how many Catch records exist initially
nrow(data$GSCAT)
[1] 259818

#apply the filters above (any table can have filters applied)
data$GSMISSIONS <- data$GSMISSIONS[data$GSMISSIONS$SEASON=="SUMMER",]
data$GSMISSIONS <- data$GSMISSIONS[data$GSMISSIONS$YEAR %in% c(2014,2015),]
data$GSSPECIES_20220624  <- data$GSSPECIES_20220624[data$GSSPECIES_20220624$CODE == 10,]

#cascade the filters above to all of the data
data <- propagateChanges(data, keep_nullsets = F)

# check that filter worked
nrow(data$GSCAT)
[1] 197

```
At this point, every table within the `data` object will only hold information directly relevant to the filters we applied.  The various tables will only hold records that can be directly linked to cod caught in the summers of 2014 and 2015.  Tables that exist but were not explicitly filtered have also be filtered.  For example, even the table that holds length, weight and age information for specific fish (i.e. `GSDET`) can now be plotted, and we can be confident it will only contain cod data:

```{r eval=FALSE}
plot(data$dataLF$FLEN, data$dataLF$FWT, pch = 19, col=factor(data$dataLF$MISSION))
legend("topleft", pch = 19, legend = unique(factor(data$dataLF$MISSION)), col = unique(factor(data$GSDET$MISSION)))
```
<img src="cod_summ_2014_2015.png" width="400" />

To "reset" the data (and remove any filtering), one would just re-run `loadRVData()` and overwrite the filtered dataset.

## Plotting data - plotRV()
To facilitate plotting of the data generated by this package, `plotRV()` is provided. Continuing with the example above, to plot the cod data from the summers of 2014 and 2015, one can do:
```{r eval=FALSE}
plotRV(data, title = "Cod: Summer 2014 and 2015")
```
which generates this:

<img src="plotrv_cod_summ_2014_2015.png" width="400" />

Less initially-filtered datasets can also be plotted, as species codes and aphiaids can be sent as 
parameters.  This means that a dataset can be created with a series of filters, and a loop can be 
created to generate numerous plots (e.g. one per species). 
## Getting Data for a Specific Survey
A particular survey is defined by a combination parameters, including:
  1. a range of months;
  2. a particular set of strata; and
  3. a particular tow 'type' (i.e. a "Stratified random survey set")
Because getting all of these things correct can be a little difficult, [getSurvey()](https://github.com/PopulationEcologyDivision/RVTransmogrifier/blob/main/R/getSurvey.R) is included to ensure they are applied correctly.  Following are examples for extracting the Spring 2016 survey data and the 2008 4VSW Survey data for 2005 and 2006:

```{r eval=FALSE}
spring_2016 <- getSurvey(survey = "SPRING", years = 2016)

surv_4VSW_2005_2006 <- getSurvey(survey = "4VSW", years = c(2005,2006))
```
and you were only interested in the squid from the Spring 2016 survey, you might further do
```{r eval=FALSE, include=FALSE}
# figure out code for 'Illex'
spring_2016$GSSPECIES_20220624[grepl("ILLEX",spring_2016$GSSPECIES_20220624$SPEC),]
> CODE               SPEC            COMM COMMENTS VALID_SPP   TSN APHIAID TAXON_STATUS ...
> 4511 ILLEX ILLECEBROSUS SHORT-FIN SQUID     <NA>         1 82521  153087         <NA> ...

# filter the species table to just get Illex
spring_2016$GSSPECIES_20220624 <- spring_2016$GSSPECIES_20220624[spring_2016$GSSPECIES_20220624$CODE == 4511,]

# cascade the filter above to limit all of the data to just those records related to squid.  Keep the
# nullsets so we can see where we looked, and didn't find them
spring_2016 <- propagateChanges(tblList = spring_2016, keep_nullsets = T)

```
To then plot the data, you might merge the set location information (i.e. GSINF) with the catch data 
(i.e. GSCAT) using the MISSION and SETNO fields
```{r eval=FALSE}
catches <- merge(spring_2016$GSINF, spring_2016$GSCAT, all.x=T, by=c("MISSION", "SETNO"))

ggplot() + 
   ggtitle("Spring Survey 2016: Squid")+ 
   annotation_map(map_data("world"), fill="darkgreen", colour="darkgrey")+
   geom_point(data=catches[!is.na(catches$TOTNO),], aes(SLONG_DD, SLAT_DD, size = TOTNO), alpha = 2/3)+
   geom_point(data=catches[is.na(catches$TOTNO),], aes(SLONG_DD, SLAT_DD),  shape=3, size= 1)+ 
   coord_sf(xlim = c(-71, -63), ylim = c(39.5, 46), expand = FALSE) 
```
which yields:

<img src="squid2016.png" width="600" />

Note how "nullsets" are present, and displayed as "+" symbols.
### WoRMS Aphia IDs
With the addition of [WoRMS aphiaids](https://www.marinespecies.org/about.php) to the species table (i.e. GSSPECIES, it is now possible to filter data at any taxonomic level rather than just discrete species.  

For example, to generate a dataset of only data for polychaetes, one could do the following
```{r eval=FALSE}
data<-loadRVData()
data$GSSPECIES<- data$GSSPECIES[which(data$GSSPECIES$CLASS == "POLYCHAETA"),]
data <- propagateChanges(data, keep_nullsets = F)
#Review contents of data$GSSPECIES element following filtering
> unique(data$GSSPECIES$SPEC)
 [1] "EUNICIDAE F."                  "POLYCHAETA C."                 "NEPHTYS SP."                  
 [4] "NEPHTYIDAE F."                 "NEREIS SP."                    "SABELLIDAE F."                
 [7] "MALDANIDAE F."                 "PECTINARIA SP."                "POTAMILLA NEGLECTA"           
[10] "NEREIDAE F."                   "OPHELIA SP."                   "TEREBELLIDAE F."              
[13] "ARENICOLA MARINA"              "SPIONIDA F."                   "TEREBELLIDA"                  
[16] "OWENIIDAE F."                  "APHRODITA HASTATA"             "APHRODITIDAE F."              
[19] "APHRODITA ACULEATA (OBSOLETE)" "APHRODITA SP."                 "CHONE SP."                    
[22] "POLYNOIDAE F."                 "LEPIDONOTUS SQUAMATUS"         "HARMOTHOE SP."                
[25] "HARMOTHOE EXTENUATA"           "GLYCERA SP."                   "GLYCERA CAPITATA"             
[28] "HYALINOECIA CF TUBICOLA"       "LAETMONICE FILICORNIS" 

```


### Upcoming
Beyond the existing loading and filtering functions, additional functions are anticipated, including:

* simple summarization of the data
* scripts for exporting the raw data to formats such as csv
* simple geospatial visualization of the data
* scripts for exporting spatialized versions of the data (e.g. sf, shapfiles)

## Reformatting Data
The primary impetus of this package was to address the need to provide versions of this data to multiple parties. 

#### FGP/Open Data
[extractFGP.R](https://github.com/PopulationEcologyDivision/RVTransmogrifier/blob/main/R/extractFGP.R) can generate dataset associated with each of the 4 [FGP/Open data records for the Maritimes Research Vessel Surveys](https://open.canada.ca/data/en/dataset/8ddcaeea-b806-4958-a79f-ba9ab645f53b) is complete.

#### OBIS 
* coming soon (this is currently performed via discrete scripts)

#### DATRAS
* coming soon (this is currently performed via the code found [here](https://github.com/Maritimes/CanaDatras), but in the interest of consistency, that code will be edited to use this data set, rather than relying on queries of our internal database)





 <!-- The next command shows the names of all the data objects held by the list, and how many records they each have. -->

 <!--  plotRV(tblList = SUMMER2016_allSp, code=10, plotNullsets = T, plotSets ="TOTWGT", labelStrata = T) -->


 <!--  #Cod fun -->
 <!--  #Limit the data to just cod -->
 <!--  SUMMER2016_cod <- getSurvey("SUMMER", code = 10, years = 2020) -->
 <!--  #plot the cod - should be identical to the previous plot -->
 <!--  plotRV(tblList = SUMMER2016_cod, plotNullsets = T, plotSets ="TOTWGT", labelStrata = T) -->

 <!--  #generate stratified dataset of cod -->
 <!--  #method 1 - specify cod while running the stratify function on all species -->
 <!--  strat2016_cod_liveFilter  <- stratify(SUMMER2016_allSp, code = 10) -->
 <!--  #method 2 - run the stratify function on an already filtered object -->
 <!--  strat2016_cod_prevFilter  <- stratify(SUMMER2016_cod) -->

 <!--  #each of the results above is a list object containing a single item: -->
 <!--  #<result>$`10` (where 10 is the code for cod) -->
 <!--  #they should be identical: -->
 <!--  # > sum(strat2016_cod_liveFilter$`10`$BIOMASS_T) -->
 <!--  # [1] 41264.48326 -->
 <!--  # > sum(strat2016_cod_prevFilter$`10`$BIOMASS_T) -->
 <!--  # [1] 41264.48326 -->

 <!--  #instead of set locations, we can also plot any of the columns from the stratified file(s) -->
 <!--  #generated above.  These include: -->
 <!--  # "TOT_WGT", "TOT_NO","MEAN_WGT", "MEAN_NO", "BIOMASS_T","ABUND", "ST_ERR_WGT", "ST_ERR_NO",  -->
 <!--  # "ST_ERR_BIOMASS", "ST_ERR_ABUND" -->
 <!--  plotRV(tblList = SUMMER2016, plotSets ='ALL',  -->
 <!--         catchStrataData = strat2016_cod_liveFilter$`10`, plotCatchStrata = "MEAN_WGT") -->

 <!--  strat2016_GADIFORMES  <- stratify(SUMMER2016, taxa = "GADIFORMES") -->
 <!--  plotRV(tblList = SUMMER2016, plotNullsets = T, plotSets =NULL,  -->
 <!--         catchStrataData = strat2016_GADIFORMES$GADIFORMES, plotCatchStrata = "BIOMASS_T") -->

 <!--  #simple plot of all Gadiformes - includes: -->
 <!--  # - ARCTIC COD, COD(ATLANTIC), CUSK, FOURBEARD ROCKLING, HADDOCK, LONGFIN HAKE,  -->
 <!--  # - MARLIN-SPIKE GRENADIER, OFF-SHORE HAKE, POLLOCK, SILVER HAKE, SQUIRREL OR RED HAKE,  -->
 <!--  # - THREEBEARD ROCKLING, WHITE HAKE and NEZUMIA -->
 <!--  plotRV(tblList = SUMMER2020, taxa = "GADIFORMES", plotNullsets = T, plotSets ="TOTWGT") -->
 <!--  #simple plot of all Gadiformes -->
 <!--  plotRV(tblList = SUMMER2020, taxa = "ARTHROPODA", plotNullsets = T, plotSets ="TOTWGT") -->
 <!--  plotRV(tblList = SUMMER2020, taxa = "ARTHROPODA", plotNullsets = T, plotSets ="TOTWGT") -->


 <!--                            #limit the data to only a few different taxa -->
 <!--  test1      <- filterSpecies(SUMMER2021, keep_nullsets = T, taxa = "ECHINODERMATA") -->

 <!--  #plot some data -->
 <!--  plotRV(tblList = SUMMER2022, taxa=c("ECHINODERMATA"), plotNullsets = T, plotSets ="TOTNO") -->

 <!--  #stratify the data (i.e. bump up values for short tows; bump down longer tows, etc) -->
 <!--  strat2021     <- stratify(SUMMER2021, code = "ECHINODERMATA") -->

 <!--  plotRV(tblList = SUMMER2022, taxa=c("ECHINODERMATA"), showNullsets = T, plotSets ="ALL",  -->
 <!--             plotBathy = "LINES", plotCatchStrata = "MEAN_WGT", catchStrataData = strat2021$ECHINODERMATA) -->

 <!--  plotRV(plotBathy = "LINES", plotCatchStrata = "MEAN_WGT", catchStrataData = strat2021$ECHINODERMATA) -->



 <!--  testFGP <- extractFGP("SUMMER", years = 2011) -->
 <!--  plotRV(tblList = test, code=10, strataVar = "BIOMASS",showNullsets = T, plotPts = F) -->
 <!--  test<-getSurvey("SUMMER", years = 2010) -->
 <!--  plotRV(tblList = test, code=10, strataVar = "BIOMASS",showNullsets = T, plotPts = F) -->
 <!--  test<-getSurvey("SUMMER", years = 2015) -->
 <!--  plotRV(tblList = test, code=10, strataVar = "BIOMASS",showNullsets = T, plotPts = F) -->
 <!--  test<-getSurvey("SUMMER", years = 2020) -->
 <!--  plotRV(tblList = test, code=10, strataVar = "BIOMASS",showNullsets = T, plotPts = T) -->

 <!--  plotRV(tblList = test, FAMILY="GADIDAE", strataVar = "BIOMASS", -->
 <!--         multiSp = T, showNullsets = T, plotPts = T) -->
 <!--  # DecapodPlot <- plotRV(tblList = test, ORDER = "DECAPODA", showNullsets = F) -->
 <!--  #  -->
 <!--  # HaddockPlot <- plotRV(tblList = test, SPECIES = "MELANOGRAMMUS AEGLEFINUS", showNullsets = F) -->
 <!--  #  -->
 <!--  # SquidPlot <- plotRV(tblList = test, ORDER = "OEGOPSIDA", plotVar = "TOTWGT", showNullsets = F) -->
 <!--  # SquidPlot <- plotRV(tblList = test, ORDER = "OEGOPSIDA", plotVar = "TOTWGT", showNullsets = F) -->
 <!--  #  -->
 <!--  # test$GSSPECIES<- test$GSSPECIES[test$GSSPECIES$CODE==11,] -->


 <!--  # test <- propagateChanges(tblList = test, keep_nullsets = F, quiet=T) -->

 <!--  # plotRV(tblList = test, showNullsets = F) -->


 <!--  # dfNWSets <- NW_sets(tblList = test) -->
 <!--  # dfNWAgg <- NW_strat(tblList = test, dfNWSets=dfNWSets) -->
 <!--  # lengthsData <-calcLengths(tblList = test, dfNWSets=dfNWSets, bySex = F) -->